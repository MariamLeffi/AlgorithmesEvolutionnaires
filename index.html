<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moteur d'Optimisation de Circuits</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --card-bg: #1a2238;
            --accent: #06b6d4;
            --accent-light: #67e8f9;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }

        h1 {
            text-align: center;
            font-size: 2.8em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.2em;
            font-weight: 500;
        }

        .problem-selector {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-bottom: 40px;
        }

        .problem-card {
            flex: 1;
            max-width: 340px;
            padding: 32px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            background: var(--bg-secondary);
        }

        .problem-card.tsp {
            background: linear-gradient(135deg, #172554, #1e3a8a);
        }

        .problem-card.scheduling {
            background: linear-gradient(135deg, #1e293b, #334155);
        }

        .problem-card.active {
            transform: translateY(-12px);
            border: 2px solid var(--accent);
            box-shadow: 0 20px 40px rgba(6, 182, 212, 0.2);
        }

        .problem-card h2 {
            color: white;
            margin-bottom: 16px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .problem-card p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1em;
        }

        .config-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .config-group {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .config-group:hover {
            border-color: var(--accent);
            transform: translateY(-4px);
        }

        .config-group label {
            display: block;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        select, input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #0f172a;
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
        }

        .btn-launch {
            display: block;
            margin: 0 auto 40px;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.4s;
            box-shadow: 0 10px 30px rgba(6, 182, 212, 0.3);
        }

        .btn-launch:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(6, 182, 212, 0.4);
        }

        .visualization-area {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            min-height: 600px;
            border: 1px solid var(--border);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 650px;
            border-radius: 16px;
            overflow: hidden;
            background: #0a0e17;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 14px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 800;
            color: var(--accent);
        }

        .loading {
            text-align: center;
            padding: 80px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 24px;
            border: 4px solid rgba(6, 182, 212, 0.2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden { display: none; }

        .circuit-node {
            fill: var(--accent);
            stroke: #0f172a;
            stroke-width: 3;
            filter: drop-shadow(0 0 8px var(--accent));
            cursor: pointer;
            transition: all 0.3s;
        }

        .circuit-node:hover {
            r: 10;
            filter: drop-shadow(0 0 15px var(--accent-light));
        }

        .circuit-path {
            stroke: var(--accent);
            stroke-width: 2.5;
            fill: none;
            stroke-linecap: round;
            filter: drop-shadow(0 0 6px var(--accent));
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        .path-optimal {
            stroke: var(--success);
            stroke-width: 4;
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        .gantt-bar {
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateX(-20px);
            animation: fadeInRight 0.6s ease-out forwards;
        }

        .gantt-bar:hover {
            filter: brightness(1.2);
            transform: scaleY(1.1) translateX(-20px);
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 10px var(--success)); }
            to { filter: drop-shadow(0 0 20px var(--success)); }
        }

        @keyframes fadeInRight {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* === NOUVEAU : Meilleur Résultat === */
        .best-result {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 16px;
            margin: 24px 0;
            border: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            justify-content: center;
            font-family: 'Inter', sans-serif;
        }

        .best-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .best-item .label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .best-item .value {
            color: var(--text-primary);
            font-weight: 700;
            background: rgba(6, 182, 212, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--accent);
        }

        .best-item .highlight {
            color: var(--success);
            font-size: 1.2em;
            font-weight: 800;
        }

        @media (max-width: 768px) {
            .best-result {
                flex-direction: column;
                align-items: center;
            }
            .best-item {
                justify-content: center;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Optimisation Algorithmique</h1>
        <p class="subtitle">Algorithmes métaheuristiques pour TSP & Ordonnancement</p>
        
        <div class="problem-selector">
            <div class="problem-card tsp active" data-problem="tsp">
                <h2>Voyageur de Commerce</h2>
                <p>Trouvez le chemin le plus court visitant toutes les villes une par une</p>
            </div>
            <div class="problem-card scheduling" data-problem="scheduling">
                <h2>Ordonnancement de Tâches</h2>
                <p>Optimisez l'organisation des tâches dans le temps</p>
            </div>
        </div>
        
        <div class="config-panel">
            <div class="config-group">
                <label>Algorithme</label>
                <select id="algorithm">
                    <option value="tabou">Recherche Tabou</option>
                    <option value="recuit">Recuit Simulé</option>
                    <option value="genetic_roulette">Génétique - Roulette</option>
                    <option value="genetic_rank">Génétique - Rang</option>
                </select>
            </div>
            <div class="config-group genetic-only">
                <label>Croisement</label>
                <select id="crossover">
                    <option value="simple">Simple</option>
                    <option value="double">Double</option>
                    <option value="uniform">Uniforme</option>
                </select>
            </div>
            <div class="config-group">
                <label>Itérations</label>
                <input type="number" id="iterations" value="200" min="50" max="1000">
            </div>
            <div class="config-group tsp-only">
                <label>Composants</label>
                <input type="number" id="cities" value="18" min="8" max="30">
            </div>
            <div class="config-group scheduling-only hidden">
                <label>Tâches</label>
                <input type="number" id="tasks" value="15" min="5" max="30">
            </div>
        </div>
        
        <button class="btn-launch" onclick="launchOptimization()">
            Lancer la Simulation
        </button>
        
        <div class="visualization-area" id="result-content">
            <div style="text-align: center; padding: 100px; color: var(--text-secondary);">
                <p style="font-size: 1.4em; font-weight: 600;">Configurez et lancez la simulation</p>
                <p style="font-size: 1.1em; margin-top: 16px; opacity: 0.7;">Visualisation en temps réel sur circuit électronique</p>
            </div>
        </div>
    </div>

    <script>
        let currentProblem = 'tsp';
        let svg, cities = [], optimalPath = [];
        let dashStyleAdded = false;

        document.querySelectorAll('.problem-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.problem-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                currentProblem = this.dataset.problem;
                
                document.querySelectorAll('.tsp-only').forEach(el => {
                    el.classList.toggle('hidden', currentProblem !== 'tsp');
                });
                document.querySelectorAll('.scheduling-only').forEach(el => {
                    el.classList.toggle('hidden', currentProblem !== 'scheduling');
                });
            });
        });

        document.getElementById('algorithm').addEventListener('change', function() {
            const isGenetic = this.value.includes('genetic');
            document.querySelectorAll('.genetic-only').forEach(el => {
                el.style.opacity = isGenetic ? '1' : '0.5';
                el.querySelector('select').disabled = !isGenetic;
            });
        });

        async function launchOptimization() {
            const resultContent = document.getElementById('result-content');
            resultContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="color: var(--accent); font-size: 1.3em; font-weight: 600;">Simulation en cours...</p>
                </div>
            `;

            const data = {
                problem: currentProblem,
                algorithm: document.getElementById('algorithm').value,
                iterations: document.getElementById('iterations').value,
                crossover: document.getElementById('crossover').value,
                cities: document.getElementById('cities').value,
                tasks: document.getElementById('tasks').value
            };

            try {
                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    if (currentProblem === 'tsp') {
                        cities = result.cities || generateRandomCities(parseInt(data.cities));
                        optimalPath = result.solution;
                        displayTSPResult(result, data);
                    } else {
                        displaySchedulingResult(result, data);
                    }
                } else {
                    resultContent.innerHTML = `<div style="text-align: center; padding: 60px; color: #ef4444;">
                        <h3>Erreur : ${result.error || 'Inconnue'}</h3>
                    </div>`;
                }
            } catch (error) {
                resultContent.innerHTML = `<div style="text-align: center; padding: 60px; color: #ef4444;">
                    <h3>Connexion échouée</h3>
                    <p>Serveur Flask non détecté</p>
                </div>`;
            }
        }

        function generateRandomCities(n) {
            const cities = [];
            const padding = 80;
            const w = 800, h = 600;
            for (let i = 0; i < n; i++) {
                cities.push({
                    x: padding + Math.random() * (w - 2 * padding),
                    y: padding + Math.random() * (h - 2 * padding),
                    id: i
                });
            }
            return cities;
        }

        function displayTSPResult(result, config) {
            const isGenetic = config.algorithm.includes('genetic');
            const algoName = config.algorithm.split('_').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
            const cost = result.cost ?? result.distance ?? 0;

            document.getElementById('result-content').innerHTML = `
                <h3 style="color: var(--accent); margin-bottom: 20px; font-size: 1.5em;">
                    Circuit PCB - Tracé Optimal
                </h3>
                <div class="canvas-container" id="tspCanvasContainer">
                    <svg id="tspSvg" width="100%" height="100%" viewBox="0 0 800 600"></svg>
                </div>

                <!-- Meilleur résultat -->
                <div class="best-result">
                    <div class="best-item">
                        <span class="label">Meilleur chemin :</span>
                        <span class="value">${result.solution.join(' → ')}</span>
                    </div>
                    <div class="best-item">
                        <span class="label">Meilleure distance :</span>
                        <span class="value highlight">${cost.toFixed(1)}</span>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-label">Coût (Distance)</div>
                        <div class="stat-value">${cost.toFixed(1)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Nombre de villes</div>
                        <div class="stat-value">${config.cities}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Algorithme</div>
                        <div class="stat-value" style="font-size: 1.3em;">${algoName}</div>
                    </div>
                    <div class="stat-card ${isGenetic ? '' : 'hidden'}">
                        <div class="stat-label">Fitness</div>
                        <div class="stat-value" style="color: var(--success);">${result.fitness !== null ? result.fitness : '—'}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Itérations</div>
                        <div class="stat-value">${config.iterations}</div>
                    </div>
                </div>
            `;

            initTSPCircuit();
        }

        function initTSPCircuit() {
            svg = document.getElementById('tspSvg');

            const pattern = document.createElementNS("http://www.w3.org/2000/svg", "pattern");
            pattern.id = "grid";
            pattern.setAttribute("width", "40");
            pattern.setAttribute("height", "40");
            pattern.setAttribute("patternUnits", "userSpaceOnUse");

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M 40 0 L 0 0 0 40");
            path.setAttribute("fill", "none");
            path.setAttribute("stroke", "#1e293b");
            path.setAttribute("stroke-width", "1");
            pattern.appendChild(path);
            svg.appendChild(pattern);

            const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            rect.setAttribute("width", "100%");
            rect.setAttribute("height", "100%");
            rect.setAttribute("fill", "url(#grid)");
            svg.appendChild(rect);

            for (let i = 0; i < cities.length; i++) {
                for (let j = i + 1; j < cities.length; j++) {
                    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    line.setAttribute("x1", cities[i].x);
                    line.setAttribute("y1", cities[i].y);
                    line.setAttribute("x2", cities[j].x);
                    line.setAttribute("y2", cities[j].y);
                    line.setAttribute("class", "circuit-path");
                    line.style.opacity = "0.15";
                    svg.appendChild(line);
                }
            }

            cities.forEach(city => {
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", city.x);
                circle.setAttribute("cy", city.y);
                circle.setAttribute("r", "8");
                circle.setAttribute("class", "circuit-node");
                circle.dataset.id = city.id;

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", city.x);
                text.setAttribute("y", city.y - 15);
                text.setAttribute("text-anchor", "middle");
                text.setAttribute("fill", "#94a3b8");
                text.setAttribute("font-size", "12");
                text.textContent = `C${city.id}`;
                svg.appendChild(text);
                svg.appendChild(circle);
            });

            setTimeout(drawOptimalPath, 500);
        }

        function drawOptimalPath() {
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            let d = "";
            optimalPath.forEach((id, i) => {
                const city = cities.find(c => c.id === id);
                if (i === 0) d += `M ${city.x} ${city.y} `;
                else d += `L ${city.x} ${city.y} `;
            });
            const first = cities.find(c => c.id === optimalPath[0]);
            d += `L ${first.x} ${first.y}`;

            path.setAttribute("d", d);
            path.setAttribute("class", "path-optimal");

            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;

            if (!dashStyleAdded) {
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes dash {
                        to { stroke-dashoffset: 0; }
                    }
                    .path-optimal { animation: dash 3s linear forwards; }
                `;
                document.head.appendChild(style);
                dashStyleAdded = true;
            }

            svg.appendChild(path);
        }

        function displaySchedulingResult(result, config) {
            const tasks = result.tasks || [];
            const makespan = result.makespan || 0;
            const algoName = config.algorithm.split('_').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');

            const svgWidth = 800;
            const svgHeight = Math.max(300, 60 + tasks.length * 50);
            const barHeight = 35;
            const padding = 60;

            const gridLines = [];
            const steps = Math.ceil(makespan / 10);
            for (let i = 0; i <= steps; i++) {
                const x = padding + (i * 10 / makespan) * (svgWidth - 2 * padding);
                gridLines.push(`
                    <line x1="${x}" y1="40" x2="${x}" y2="${svgHeight - 20}" stroke="#334155" stroke-width="1"/>
                    <text x="${x}" y="30" fill="#94a3b8" font-size="12" text-anchor="middle">${i * 10}</text>
                `);
            }

            let ganttSVG = `
                <h3 style="color: var(--accent); margin-bottom: 20px; font-size: 1.5em;">
                    Ordonnancement - Diagramme de Gantt
                </h3>
                <div class="canvas-container">
                    <svg width="100%" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" style="background: #0a0e17; border-radius: 12px;">
                        ${gridLines.join('')}
                        <line x1="${padding}" y1="40" x2="${svgWidth - padding}" y2="40" stroke="#334155" stroke-width="2"/>
                        <text x="${svgWidth / 2}" y="20" fill="#94a3b8" font-size="14" text-anchor="middle">Temps</text>
            `;

            tasks.forEach((task, index) => {
                const y = 60 + index * 50;
                const startX = padding + (task.start / makespan) * (svgWidth - 2 * padding);
                const width = Math.max(10, (task.duration / makespan) * (svgWidth - 2 * padding));

                ganttSVG += `
                    <rect class="gantt-bar" x="${startX}" y="${y}" width="${width}" height="${barHeight}" 
                          fill="${task.color}" rx="6" style="animation-delay: ${index * 0.1}s;"/>
                    <text x="${startX + width / 2}" y="${y + barHeight / 2 + 5}" 
                          fill="white" font-size="14" font-weight="600" text-anchor="middle">
                        T${task.id} (${task.duration})
                    </text>
                    <text x="20" y="${y + barHeight / 2 + 5}" fill="#e2e8f0" font-size="14" font-weight="500">
                        Tâche ${task.id}
                    </text>
                `;
            });

            ganttSVG += `
                    </svg>
                </div>

                <!-- Meilleur résultat -->
                <div class="best-result">
                    <div class="best-item">
                        <span class="label">Meilleur ordre :</span>
                        <span class="value">${result.solution.join(' → ')}</span>
                    </div>
                    <div class="best-item">
                        <span class="label">Meilleur temps total :</span>
                        <span class="value highlight">${makespan}</span>
                    </div>
                </div>

                <div class="stats-panel">
                    <div class="stat-card">
                        <div class="stat-label">Coût (Temps)</div>
                        <div class="stat-value" style="color: var(--success);">${makespan}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tâches</div>
                        <div class="stat-value">${config.tasks}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Algorithme</div>
                        <div class="stat-value" style="font-size: 1.3em;">${algoName}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Itérations</div>
                        <div class="stat-value">${config.iterations}</div>
                    </div>
                </div>
            `;

            document.getElementById('result-content').innerHTML = ganttSVG;
        }

        // Initialisation
        document.querySelectorAll('.genetic-only select').forEach(el => el.disabled = true);
        document.querySelectorAll('.genetic-only').forEach(el => el.style.opacity = '0.5');
    </script>
</body>
</html>